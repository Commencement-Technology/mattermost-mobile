name: prepare-ios-build
description: Action to prepare environment for ios build

runs:
  using: composite
  steps:
    - name: ci/install-os-deps
      env:
        HOMEBREW_NO_AUTO_UPDATE: "1"
      shell: bash
      run: |
        echo "::group::install-os-deps"
        VERSION="v2024.01.22.00"

        # Download the source code
        curl -LO https://github.com/facebook/watchman/archive/${VERSION}.tar.gz

        # Extract the archive
        tar -xf ${VERSION}.tar.gz

        # Move to the extracted directory
        cd watchman-${VERSION:1}

        # Install dependencies using Homebrew (assuming you have Homebrew installed)
        brew install openssl boost

        # Configure and build Watchman
        ./autogen.sh
        ./configure
        make

        # Install Watchman (requires root privileges)
        make install

        # Remove the downloaded archive and extracted directory (optional)
        rm -rf ../${VERSION}.tar.gz watchman-${VERSION:1}

        echo "Watchman version ${VERSION} has been installed."

        echo "::endgroup::"

    - name: ci/prepare-mobile-build
      uses: ./.github/actions/prepare-mobile-build

    - name: ci/install-pods-dependencies
      shell: bash
      run: |
        echo "::group::install-pods-dependencies"
        npm run ios-gems
        npm run pod-install
        echo "::endgroup::"
